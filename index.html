<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotC Script Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-title">
            <i class="fas fa-cogs"></i>
            <h2>Script Builder</h2>
        </div>
        
        <div class="input-group">
            <label for="role-json">Role JSON Configuration:</label>
            <textarea id="role-json" spellcheck="false">[{"id":"washerwoman"},{"id":"librarian"},{"id":"investigator"},{"id":"chef"},{"id":"empath"},{"id":"fortune_teller"},{"id":"undertaker"},{"id":"monk"},{"id":"ravenkeeper"},{"id":"virgin"},{"id":"slayer"},{"id":"soldier"},{"id":"mayor"},{"id":"butler"},{"id":"drunk"},{"id":"recluse"},{"id":"saint"},{"id":"poisoner"},{"id":"spy"},{"id":"scarlet_woman"},{"id":"baron"},{"id":"imp"}]</textarea>
        </div>
        
        <button id="generate-btn" class="btn">
            <i class="fas fa-bolt"></i>
            <span>Generate Script</span>
        </button>
        
        <div class="instructions">
            <h3>How to use:</h3>
            <ul>
                <li>Enter role IDs in JSON format in the textarea</li>
                <li>Click "Generate Script" to create your script</li>
                <li>Roles will appear in the main grid area</li>
                <li>Use your browser's print function to print the script</li>
            </ul>
        </div>
    </aside>
    
    <!-- Main Content -->
    <div class="main-content">
        <header>
            <div class="logo">
                <i class="fas fa-moon"></i>
                <h1>Blood on the Clocktower Script Builder</h1>
            </div>
            <div class="controls">
                <button class="btn" id="print-btn">
                    <i class="fas fa-print"></i>
                    <span>Print Script</span>
                </button>
                <button class="btn" id="save-btn">
                    <i class="fas fa-save"></i>
                    <span>Save Script</span>
                </button>
            </div>
        </header>
        
        <div class="script-container">
            <div class="script-header">
                <h2>Trouble Brewing</h2>
                <p>A standard 22-role script for Blood on the Clocktower. Perfect for beginners and experienced players alike.</p>
            </div>
            
            <div class="roles-grid" id="roles-grid">
                <!-- Role cards will be dynamically inserted here -->
            </div>
        </div>
        
        <footer>
            <p>BotC Script Builder &copy; 2023 | This tool is unofficial and not affiliated with The Pandemonium Institute</p>
        </footer>
    </div>
    
    <script>
        // Icon mapping remains the same as hardcoded version
        const roleIcons = {
            washerwoman: "üëö",
            librarian: "üìö",
            investigator: "üîç",
            chef: "üë®‚Äçüç≥",
            empath: "üíñ",
            fortune_teller: "üîÆ",
            undertaker: "‚ö∞Ô∏è",
            monk: "üßò",
            ravenkeeper: "üê¶",
            virgin: "üíÉ",
            slayer: "üèπ",
            soldier: "ü™ñ",
            mayor: "üéñÔ∏è",
            butler: "üßë‚Äçüç≥",
            drunk: "üç∫",
            recluse: "üèöÔ∏è",
            saint: "üòá",
            poisoner: "üß™",
            spy: "üïµÔ∏è",
            scarlet_woman: "üíÉ",
            baron: "üé©",
            imp: "üòà"
        };
        
        // DOM Elements
        const roleJsonTextarea = document.getElementById('role-json');
        const generateBtn = document.getElementById('generate-btn');
        const printBtn = document.getElementById('print-btn');
        const saveBtn = document.getElementById('save-btn');
        const rolesGrid = document.getElementById('roles-grid');
        
        // Fetch role data from JSON file
        async function loadRoleData() {
            try {
                const response = await fetch('roles/roles.json');
                const roles = await response.json();
                
                // Convert array into lookup dictionary
                return roles.reduce((map, role) => {
                    map[role.id] = {
                        ...role,
                        type: role.team  // Map "team" to "type" for compatibility
                    };
                    return map;
                }, {});
            } catch (error) {
                console.error('Error loading role data:', error);
                return {};
            }
        }
        
        // Generate role cards
        async function generateRoleCards() {
            try {
                // Clear existing cards
                rolesGrid.innerHTML = '';
                
                // Parse JSON input
                const roleConfig = JSON.parse(roleJsonTextarea.value);
                const roleDatabase = await loadRoleData();
                
                // Create cards for each role
                roleConfig.forEach(roleConfig => {
                    const roleId = roleConfig.id;
                    const role = roleDatabase[roleId];
                    const icon = roleIcons[roleId] || "‚ùì";
                    
                    if (role) {
                        const roleCard = document.createElement('div');
                        roleCard.className = `role-card ${role.type}`;
                        
                        roleCard.innerHTML = `
                            <div class="role-header">
                                <div class="role-name">${role.name}</div>
                                <div class="role-type ${role.type}">${role.type.charAt(0).toUpperCase() + role.type.slice(1)}</div>
                            </div>
                            <div class="role-ability">${role.ability}</div>
                            <div class="role-icon">${icon}</div>
                        `;
                        
                        rolesGrid.appendChild(roleCard);
                    } else {
                        // Fallback for unknown roles
                        const errorCard = document.createElement('div');
                        errorCard.className = 'role-card';
                        errorCard.innerHTML = `
                            <div class="role-header">
                                <div class="role-name">Error: ${roleId}</div>
                                <div class="role-type">Unknown</div>
                            </div>
                            <div class="role-ability">Role not found in database</div>
                            <div class="role-icon">‚ùå</div>
                        `;
                        rolesGrid.appendChild(errorCard);
                    }
                });
                
                // Fill remaining slots with empty cards
                const remainingSlots = 22 - roleConfig.length;
                for (let i = 0; i < remainingSlots; i++) {
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'role-card';
                    emptyCard.innerHTML = `
                        <div class="role-header">
                            <div class="role-name">Empty Slot</div>
                            <div class="role-type">Add Role</div>
                        </div>
                        <div class="role-ability">Add a role ID to the JSON to display it here</div>
                        <div class="role-icon">‚ùì</div>
                    `;
                    rolesGrid.appendChild(emptyCard);
                }
            } catch (error) {
                alert('Invalid JSON format. Please check your input.');
                console.error(error);
            }
        }
        
        // Event Listeners
        generateBtn.addEventListener('click', generateRoleCards);
        printBtn.addEventListener('click', () => window.print());
        saveBtn.addEventListener('click', () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(roleJsonTextarea.value);
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", "botc-script.json");
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', generateRoleCards);
    </script>
</body>
</html>